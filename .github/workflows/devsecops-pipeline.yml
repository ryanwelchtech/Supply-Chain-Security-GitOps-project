name: DevSecOps-Pipeline
on: [push]

jobs:
  build-scan-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          IMAGE_TAG=${{ github.sha }}
          docker build -t hardened-app:${IMAGE_TAG} .
          echo "LOCAL_IMAGE=hardened-app:${IMAGE_TAG}" >> $GITHUB_ENV
          echo "OPENSHIFT_IMAGE=image-registry.openshift-image-registry.svc:5000/hardened-path/hardened-app:${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Security Scan (Trivy) - Fail on High/Critical
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.LOCAL_IMAGE }}
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      # FIX: Explicitly install oc CLI first
      - name: Install OpenShift CLI (oc)
        uses: redhat-actions/oc-installer@v1
        with:
          oc_version: 'latest'  # Matches Sandbox version; use 'latest' if issues

      # Now login works reliably
      - name: Login to OpenShift Sandbox
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER_URL }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          insecure: true

      - name: Setup namespace and push image
        run: |
          # Create/ switch to namespace
        #oc new-project hardened-path || true
        #oc project hardened-path uncomment/* if project needs to be created

          oc project rywel-dev # Use your existing OpenShift Sandbox project name
          
          # Docker login to OpenShift registry
          echo "$(oc whoami -t)" | docker login -u "$(oc whoami)" --password-stdin image-registry.openshift-image-registry.svc:5000
          
          # Tag & push
          docker tag ${{ env.LOCAL_IMAGE }} ${{ env.OPENSHIFT_IMAGE }}
          docker push ${{ env.OPENSHIFT_IMAGE }}
          
          # Tag ImageStream for deployment
          oc tag ${{ env.OPENSHIFT_IMAGE }} hardened-path/hardened-app:latest

      - name: Deploy secure manifests
        run: |
          oc apply -f k8s/ -R  # -R recurses directory

      - name: Verify deployment
        run: |
          oc rollout status deployment/hardened-app --timeout=300s
          oc get route hardened-app-route -o jsonpath='{.spec.host}'  # Outputs public URL
