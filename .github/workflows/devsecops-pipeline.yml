name: DevSecOps-Pipeline
on: [push]

jobs:
  build-scan-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          IMAGE_TAG=${{ github.sha }}
          docker build -t hardened-app:${IMAGE_TAG} .
          echo "LOCAL_IMAGE=hardened-app:${IMAGE_TAG}" >> $GITHUB_ENV
          echo "OPENSHIFT_IMAGE=image-registry.openshift-image-registry.svc:5000/rywel-dev/hardened-app:${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Security Scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.LOCAL_IMAGE }}
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Install OpenShift CLI (oc)
        uses: redhat-actions/oc-installer@v1
        with:
          oc_version: 'latest'  # Or 'latest' / your oc version

      - name: Login to OpenShift Sandbox
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER_URL }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          insecure: true

      - name: Switch to rywel-dev & push image
        run: |
          oc project rywel-dev  # âœ… Use YOUR existing namespace
          echo "$(oc whoami -t)" | docker login -u "$(oc whoami)" --password-stdin image-registry.openshift-image-registry.svc:5000
          docker tag ${{ env.LOCAL_IMAGE }} ${{ env.OPENSHIFT_IMAGE }}
          docker push ${{ env.OPENSHIFT_IMAGE }}
          oc tag ${{ env.OPENSHIFT_IMAGE }} rywel-dev/hardened-app:latest  # Namespace ImageStream

      - name: Deploy/upsert manifests (idempotent)
        run: |
          oc apply -f k8s/ -R --server-side=true --force=true  # Handles existing resources

      - name: Verify deployment & expose URL
        run: |
          oc project rywel-dev
          oc rollout status deployment/hardened-app --timeout=300s || true
          echo "::notice title=Public URL:: http://$(oc get route hardened-app-route -o jsonpath='{.spec.host}')/"
