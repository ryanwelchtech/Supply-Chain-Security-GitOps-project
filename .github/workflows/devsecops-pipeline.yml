name: DevSecOps-Pipeline
on: [push]

jobs:
  build-scan-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and tag image
        run: |
          IMAGE_TAG=${{ github.sha }}
          docker build -t hardened-app:${IMAGE_TAG} .
          echo "IMAGE=image-registry.openshift-image-registry.svc:5000/$(oc project -q)/hardened-app:${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Security Scan (Trivy) - Block High/Critical CVEs
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: hardened-app:${{ github.sha }}
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true  # Allows known unfixed if low risk

      - name: Login to OpenShift Sandbox
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER_URL }}  # e.g., https://api.sandbox.x8i5.p1.openshiftapps.com:6443
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}  # From oc whoami --show-token
          insecure: true  # Sandbox uses self-signed certs

      - name: Create namespace and push image
        run: |
          oc new-project hardened-path --display-name="Hardened-Path Demo" || true
          oc project hardened-path
          docker login -u $(oc whoami) -p $(oc whoami -t) image-registry.openshift-image-registry.svc:5000
          docker tag hardened-app:${{ github.sha }} image-registry.openshift-image-registry.svc:5000/hardened-path/hardened-app:${{ github.sha }}
          docker push image-registry.openshift-image-registry.svc:5000/hardened-path/hardened-app:${{ github.sha }}

      - name: Deploy manifests
        run: |
          oc apply -f k8s/quota.yaml
          oc apply -f k8s/network-policy.yaml
          oc apply -f k8s/service.yaml
          oc apply -f k8s/deployment.yaml
          oc apply -f k8s/route.yaml